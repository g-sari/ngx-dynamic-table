<mat-table #expandableTable [dataSource]="dataSource" multiTemplateDataRows matSort class="pal-table mat-elevation-z2">

    <!-- Expandable Row Column -->
    <ng-container matColumnDef="expandableColumn">
        <mat-header-cell *matHeaderCellDef class="expandable-row-column"></mat-header-cell>
        <mat-cell *matCellDef="let row; let rowIndex = dataIndex;" class="expandable-row-column" [style.background]="getColumnColor('expandableColumn')"
            (click)="selectItem(rowIndex);">
            <mat-icon *ngIf="expandedElement !== row" class="expandable-row-icon" svgIcon="expand"></mat-icon>
            <mat-icon *ngIf="expandedElement === row" class="expandable-row-icon" svgIcon="expand"></mat-icon>
        </mat-cell>
    </ng-container>

    <!-- Position Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.INDICATOR_COLOR}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.INDICATOR_COLOR)">
        <mat-header-cell *matHeaderCellDef class="color-column" mat-sort-header>{{getColumnName(COLUMN_DEFINITIONS.INDICATOR_COLOR)}}</mat-header-cell>
        <mat-cell *matCellDef="let item; let rowIndex = dataIndex;" [style.background-color]="getIndicatorColor(item, rowIndex)"
            class="color-column">
            {{(rowIndex+1)}} {{getIndicatorSign(item, rowIndex)}} </mat-cell>
    </ng-container>

    <!-- Icon column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.HTML_ICON}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.HTML_ICON)">
        <mat-header-cell *matHeaderCellDef class="icon-column">{{getColumnName(COLUMN_DEFINITIONS.HTML_ICON)}}</mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="icon-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.HTML_ICON)">
            {{getHTMLIcon(item, i)}}
            <ng-template [palTableIconContainer]="i"></ng-template>
        </mat-cell>
    </ng-container>

    <!-- Title Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.TITLE}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.TITLE)">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="title-column">
            {{getColumnName(COLUMN_DEFINITIONS.TITLE)}}
        </mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="title-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.TITLE)">
            {{getTitle(item, i)}}
            <ng-template [palTableTitleContainer]="i"></ng-template>
        </mat-cell>
    </ng-container>

    <!-- Description column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.DESCRIPTION}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.DESCRIPTION)">
        <mat-header-cell *matHeaderCellDef class="description-column" mat-sort-header>
            {{getColumnName(COLUMN_DEFINITIONS.DESCRIPTION)}}
        </mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="description-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.DESCRIPTION)">
            {{getDescription(item, i)}}
            <ng-template [palTableDescriptionContainer]="i"></ng-template>
        </mat-cell>
    </ng-container>

    <!-- Additional info column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.ADDITIONAL_INFO}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.ADDITIONAL_INFO)">
        <mat-header-cell *matHeaderCellDef class="additional-info-column" mat-sort-header>{{getColumnName(COLUMN_DEFINITIONS.ADDITIONAL_INFO)}}</mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="additional-info-column" fxLayout="row"
            fxLayoutAlign="space-around center" [style.background]="getColumnColor(COLUMN_DEFINITIONS.ADDITIONAL_INFO)">
            {{getAdditionalInfo(item, i)}}
            <ng-template [palTableAdditionalInfoContainer]="i"></ng-template>
        </mat-cell>
    </ng-container>

    <!-- Other Text Based Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.OTHER_TEXT_BASED1}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.OTHER_TEXT_BASED1)">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="other-text-based-column">{{getColumnName(COLUMN_DEFINITIONS.OTHER_TEXT_BASED1)}}</mat-header-cell>
        <mat-cell *matCellDef="let item" class="other-text-based-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.OTHER_TEXT_BASED1)">
            {{getOtherTextBased(item, 1)}}
        </mat-cell>
    </ng-container>


    <!-- Other Text Based Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.OTHER_TEXT_BASED2}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.OTHER_TEXT_BASED2)">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="other-text-based-column">{{getColumnName(COLUMN_DEFINITIONS.OTHER_TEXT_BASED2)}}</mat-header-cell>
        <mat-cell *matCellDef="let item" class="other-text-based-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.OTHER_TEXT_BASED2)">
            {{getOtherTextBased(item, 2)}}
        </mat-cell>
    </ng-container>


    <!-- Other Text Based Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.OTHER_TEXT_BASED3}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.OTHER_TEXT_BASED3)">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="other-text-based-column">{{getColumnName(COLUMN_DEFINITIONS.OTHER_TEXT_BASED3)}}</mat-header-cell>
        <mat-cell *matCellDef="let item" class="other-text-based-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.OTHER_TEXT_BASED3)">
            {{getOtherTextBased(item, 3)}}
        </mat-cell>
    </ng-container>


    <!-- Other Text Based Column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.OTHER_TEXT_BASED4}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.OTHER_TEXT_BASED4)">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="other-text-based-column">{{getColumnName(COLUMN_DEFINITIONS.OTHER_TEXT_BASED4)}}</mat-header-cell>
        <mat-cell *matCellDef="let item" class="other-text-based-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.OTHER_TEXT_BASED4)">
            {{getOtherTextBased(item, 4)}}
        </mat-cell>
    </ng-container>

    <!-- Content summary column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.HTML_CONTENT_SUMMARY}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.HTML_CONTENT_SUMMARY)">
        <mat-header-cell *matHeaderCellDef class="html-content-summary-column" mat-sort-header>{{getColumnName(COLUMN_DEFINITIONS.HTML_CONTENT_SUMMARY)}}</mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="html-content-summary-column" fxLayout="row"
            fxLayoutAlign="space-around center" [style.background]="getColumnColor(COLUMN_DEFINITIONS.HTML_CONTENT_SUMMARY)">
            {{getHTMLContentSummary(item, i)}}
            <ng-template [palTableContentSummaryContainer]="i"></ng-template>
        </mat-cell>
    </ng-container>

    <!-- Actions column -->
    <ng-container matColumnDef="{{COLUMN_DEFINITIONS.HTML_ACTIONS}}" *ngIf="isColumnDefined(COLUMN_DEFINITIONS.HTML_ACTIONS)">
        <mat-header-cell *matHeaderCellDef class="actions-column">{{getColumnName(COLUMN_DEFINITIONS.HTML_ACTIONS)}}</mat-header-cell>
        <mat-cell *matCellDef="let item; let i = dataIndex;" class="actions-column" [style.background]="getColumnColor(COLUMN_DEFINITIONS.HTML_ACTIONS)">
            <div fxLayout="row" fxLayoutAlign="space-around center">
                {{getHTMLAction(item, i)}}
                <ng-template [palTableActionsContainer]="i"></ng-template>
            </div>
        </mat-cell>
    </ng-container>

    <!-- Expanded Item Content Column - The detail row is made up of this one column that spans across all columns -->
    <ng-container matColumnDef="expandedDetail">
        <mat-cell *matCellDef="let element; let rowIndex = dataIndex;" [attr.colspan]="displayedColumns.length" class="example-element-detail">
            <div [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'" class="expanded-container"
                *ngIf="element == expandedElement">
                <table mat-table matSort [dataSource]="getExpandedItemTableData(element)" multiTemplateDataRows class="expanded-table mat-elevation-z8">

                    <div *ngFor="let expandedTableColumn of getExpandedItemTableColumns(element)">
                        <!-- Expanded Item Expandable Row Column -->
                        <ng-container *ngIf="expandedTableColumn.columnId === 'expandedItemExpandableColumn'"
                            matColumnDef="expandedItemExpandableColumn">
                            <mat-header-cell *matHeaderCellDef mat-sort-header [style.background]="expandedTableColumn.backgroundColor"
                                [style.color]="expandedTableColumn.color" class="expanded-item-header-column expanded-item-column-{{expandedTableColumn.columnId}}">
                                <mat-icon [style.color]="expandedTableColumn.color">{{expandedTableColumn.icon}}</mat-icon>
                            </mat-header-cell>
                            <mat-cell *matCellDef="let expandedItem; let expandedItemRowIndex = dataIndex;" class="expanded-item-column expanded-item-column-{{expandedTableColumn.columnId}}"
                                (click)="selectItem2(expandedItem, element);">
                                <mat-icon *ngIf="expandedItem !== expandedElement2" class="expanded-item-expand-row-icon">play_arrow</mat-icon>
                                <mat-icon *ngIf="expandedItem === expandedElement2" class="expanded-item-collapse-row-icon">arrow_drop_down</mat-icon>
                            </mat-cell>
                        </ng-container>

                        <!-- Text based Columns -->
                        <ng-container *ngIf="expandedTableColumn.columnId !== 'expandedItemExpandableColumn'"
                            matColumnDef="{{expandedTableColumn.columnId}}">
                            <mat-header-cell *matHeaderCellDef mat-sort-header [style.background]="expandedTableColumn.backgroundColor"
                                [style.color]="expandedTableColumn.color" class="expanded-item-header-column expanded-item-column-{{expandedTableColumn.columnId}}">
                                <mat-icon>{{expandedTableColumn.icon}}</mat-icon> {{expandedTableColumn.column}}
                            </mat-header-cell>
                            <mat-cell *matCellDef="let expandedItem; let expandedItemRowIndex = dataIndex;" class="expanded-item-column expanded-item-column-{{expandedTableColumn.columnId}}">
                                {{expandedItem[expandedTableColumn.columnId]}}
                            </mat-cell>
                        </ng-container>
                    </div>

                    <!-- Expanded Item Details Content -->
                    <ng-container matColumnDef="expandedDetail2">
                        <mat-cell *matCellDef="let element2; let rowIndex = dataIndex;" [attr.colspan]="displayedColumns.length"
                            class="example-element-detail">

                            <div [@detailExpand]="element2 == expandedElement2 ? 'expanded' : 'collapsed'" *ngIf="element2 == expandedElement2"
                                class="expanded-container">

                                <table mat-table matSort [dataSource]="expandedItemDetailsDataSource" class="expanded-table mat-elevation-z8">

                                    <!-- Columns -->
                                    <ng-container *ngFor="let expandedTableColumn of getExpandedItemDetailsTableColumns(element2, element)"
                                        matColumnDef="{{expandedTableColumn.columnId}}">
                                        <mat-header-cell *matHeaderCellDef mat-sort-header [style.background]="expandedTableColumn.backgroundColor"
                                            [style.color]="expandedTableColumn.color" class="expanded-item-detail-header-column expanded-item-detail-column-{{expandedTableColumn.columnId}}">
                                            <mat-icon *ngIf="expandedTableColumn.icon !== null" svgIcon="{{expandedTableColumn.icon}}"
                                                [style.color]="expandedTableColumn.color">{{expandedTableColumn.icon}}</mat-icon>
                                            {{expandedTableColumn.column}}
                                        </mat-header-cell>
                                        <mat-cell *matCellDef="let expandedItem; let expandedItemRowIndex = dataIndex;"
                                            class="expanded-item-detail-column expanded-item-detail-column-{{expandedTableColumn.columnId}}">
                                            <mat-icon *ngIf="expandedTableColumn.icon !== null" svgIcon="{{expandedTableColumn.icon}}"
                                                class="expanded-item-detail-column-expanded-row">{{expandedTableColumn.icon}}</mat-icon>
                                            {{expandedItem[expandedTableColumn.columnId]}}
                                        </mat-cell>
                                    </ng-container>


                                    <mat-header-row *matHeaderRowDef="getExpandedItemDetailsTableColumnIds(element2, element)"
                                        [ngClass]="{'no-header-columns': hideColumnsOfExpandedItemDetails}"></mat-header-row>
                                    <mat-row *matRowDef="let element2; columns: getExpandedItemDetailsTableColumnIds(element2, element);"
                                        (click)="selectItem2(element2, element);"></mat-row>
                                </table>

                                <div class="pal-table-loading-shade" *ngIf="isLoadingExpandedItemResults || noExpandedItemDataFound">
                                    <div class="loading-shade-container">
                                        <div fxLayout="column" fxLayoutAlign="space-around center" *ngIf="isLoadingExpandedItemResults">
                                            <mat-spinner mode="indeterminate" color="accent" [diameter]="50"
                                                [strokeWidth]="2"></mat-spinner>
                                            <!-- <mat-progress-bar mode="buffer" color="accent"></mat-progress-bar> -->
                                            <span class="loading-message">wird geladen...</span>
                                        </div>
                                        <!--
                                        <div fxLayout="column" fxLayoutAlign="space-around center" class="pal-table-message"
                                            *ngIf="noExpandedItemDataFound">
                                            <mat-icon svgIcon="no-data-found" class="no-data-found-icon"></mat-icon>
                                            <span class="no-data-found-text">No data found!</span>
                                        </div>
                                        -->
                                    </div>
                                </div>
                            </div>
                        </mat-cell>
                    </ng-container>


                    <mat-header-row *matHeaderRowDef="getExpandedItemTableColumnIds(element)" [ngClass]="{'no-header-columns': hideColumnsOfExpandedItems}"
                        class="expanded-item-header-row"></mat-header-row>
                    <mat-row *matRowDef="let element; columns: getExpandedItemTableColumnIds(element);"></mat-row>
                    <mat-row *matRowDef="let element2; columns: ['expandedDetail2']" class="expanded-item-row"
                        [ngStyle]="{ 'display': expandedElement2 === element2 ? 'inline' : 'none' }"></mat-row>
                </table>
            </div>
        </mat-cell>
    </ng-container>

    <mat-header-row *matHeaderRowDef="displayedColumns" [ngClass]="{'no-header-columns': hideColumns}"></mat-header-row>
    <!-- TABLE ITEM ROW -->
    <mat-row *matRowDef="let row; columns: displayedColumns; let rowIndex = dataIndex;" class="table-item-row"
        [class.example-expanded-row]="expandedElement === row" [class.mat-elevation-z1]="currentSelectedRowIndex == rowIndex"
        [style.background]="getItemRowColor()" [ngClass]="{'current-selected-row': currentSelectedRowIndex == rowIndex}">
    </mat-row>
    <!-- EXPANDED ITEM ROW -->
    <mat-row *matRowDef="let row; let rowIndex = dataIndex; columns: ['expandedDetail']" class="expanded-item-row"
        [ngStyle]="{ 'display': expandedElement === row ? 'inline' : 'none' }">
    </mat-row>
</mat-table>

<div class="pal-table-loading-shade" *ngIf="isLoadingResults || noDataFound">
    <div class="loading-shade-container">
        <div fxLayout="column" fxLayoutAlign="space-around center" *ngIf="isLoadingResults">
            <mat-spinner mode="indeterminate" color="primary" [diameter]="80" [strokeWidth]="2"></mat-spinner>
            <!-- <mat-progress-bar mode="buffer" color="accent"></mat-progress-bar> -->
            <span class="loading-message">wird geladen...</span>
        </div>
    <!--
        <div fxLayout="column" fxLayoutAlign="space-around center" class="pal-table-message" *ngIf="noDataFound">
            <mat-icon svgIcon="no-data-found" class="no-data-found-icon"></mat-icon>
            <span class="no-data-found-text">No data found!</span>
        </div>
    -->
    </div>
</div>